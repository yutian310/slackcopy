id: nacos-jraftserver-deserialization-rce

info:
  name: Nacos - jraftserver deserialization Remote Code Execution
  author: qwtd
  severity: critical
  description: |
    Nacos uses Hessian for deserialization when processing certain Jraft-based requests. Lack of deserialization restrictions leads to Remote Code Execution (RCE) vulnerabilities.
    Affected versions:
    - 1.4.0 ≤ Nacos < 1.4.6 (only in cluster mode)
    - 2.0.0 ≤ Nacos < 2.2.3 (any mode) 
  reference: https://stack.chaitin.com/techblog/detail?id=106
  tags: Alibaba-Nacos
  metadata:
    max-request: 1

http:
  - method: GET
    path:
      - "{{BaseURL}}/nacos/v1/console/server/state"
      - "{{BaseURL}}/v1/console/server/state"

    matchers-condition: or
    matchers:
      # 对于 1.4.0 - 1.4.5，必须是集群模式
      - type: regex
        regex:
          - '"version":"1\.4\.[0-5]"'
          - '"standalone_mode":"cluster"'
        part: body
        condition: and

      # 对于 2.0.0 - 2.2.2，不需要匹配 standalone_mode
      - type: regex
        name: 2.x-any-mode
        regex:
          - '"version":"2\.(0|1|2)\.[0-2]"'
        part: body

    extractors:
      - type: regex
        name: version
        part: body
        regex:
          - '"version":"(.*?)"'
